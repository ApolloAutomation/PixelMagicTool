<!DOCTYPE html>
<html lang="pt_BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAA8lAAAPJQGo42USAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAV9QTFRF////AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdljQDwAAAHR0Uk5TAAEDBAYHCAkLDA4PEhUXGB0gISMnLDE1ODo8QEJESE1OT1BRU1RVVlhZX2BmaGxtb3BzdHZ3eHx9fn+Cg4SFiImLkJGXmJmboKGipqeoq62usLa7vMLFx8jM0NHS09XW2Nne4ePl5+nq7O3v9ff4+vv8/f6cGFczAAAIFUlEQVR42u3c6VuUVRzH4UO2jSlLTUFDRVlRJOkYQYVFUzktU0nQEEkWWdFGEMr8/1eKVprIAzHHmud3f17z4lzfczPALKS0d5XaeL3Raq+ud9RTra+2W436eK2SDtHA5OKmKXu7zcXJgX93+9Xp5W37laHt5enqga9/bMVwZWpl7EDXP7JksrK1NLL/B/95c5Wx+f39IOhvbtmqnG01+4vvf3jNUOVtbbjo/ic2rFTmNib2vP6+OROVvbm+PZ72W7BP+Vu445ODgxetE6GLg3f4/nf/UQTs+hjQ5/E/TAu7/R7g979Aze3y959VInXbX4PD/v4P1cY/nhHq9/xfsNZufVa4aZFoNW95/c/rP+Hauvm1Qa//Bmz+pvd/WCNif79DxPt/Qrb01/v/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"
    />
    <title>2D MATRIX CONVERTER</title>
    <style>
      * {
        box-sizing: border-box;
      }

      ::selection {
        background: #191970;
        color: #ffffff;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        display: flex;
        /* justify-content: center;
        align-items: center; */
        min-height: 100vh;
        margin: 0;
        font-size: 14px;
        font-family: monospace !important;
      }

      #code {
        width: 100%;
        height: 100%;
        padding: 20px;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
      }

      .toast {
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        padding: 8px 8px 8px 16px;
        margin: 10px 0 0;
        border-radius: 8px;
        color: #fff;
        font-size: 12px;
        box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.4);
        animation-name: fadeIn;
        animation-duration: 0.5s;
        animation-fill-mode: forwards;
        animation-timing-function: ease-in-out;
      }

      .toast.success {
        background-color: #28a745;
      }

      .toast.error {
        background-color: #dc3545;
      }

      .toast.warning {
        background-color: #dcb535;
      }

      .toast .close {
        cursor: pointer;
        width: 22px;
        height: 22px;
        padding: 4px;
        border-radius: 50%;
        transition: background-color 0.2s ease-in-out;
      }

      .toast .close:hover {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transition: background-color 0.2s ease-in-out;
      }
    </style>
  </head>
  <body>
    <pre id="code"></pre>
    <div id="toast-container"></div>
  </body>
  <script>
    async function extractUrlParameters() {
      const protocol = window.location.protocol;
      const query = window.location.search;
      const params = new URLSearchParams(query);

      const hostname = params.get("hostname");
      const image = params.get("image");

      const response = await fetch(`${protocol}//${hostname}/${image}`);
      const blob = await response.blob();

      const body = new FormData();

      const file = new File([blob], "image", { type: blob.type });
      body.append("image", file);

      await execute(body, query, params);
    }

    async function execute(body, query, params) {
      const mode = params.get("mode") ? params.get("mode") : "production";
      const filename = params.get("image").replace(/\.[^.]+$/, "");
      const hostname = params.get("hostname");
      const output = params.get("output");

      const download =
        params.get("download") && params.get("download") === "true"
          ? true
          : false;

      const simulate =
        params.get("simulate") && params.get("simulate") === "true"
          ? true
          : false;

      const url =
        mode === "dev"
          ? `http://localhost:3333/api/wled/url${query}`
          : `https://ajotark.vercel.app/api/wled/url${query}`;

      try {
        const response = await fetch(url, {
          method: "POST",
          body: body,
        });
        const data = await response.text();

        if (!response.ok) {
          const { issues } = JSON.parse(data);

          Object.entries(issues).forEach((issue) => {
            const [error, message] = issue;

            if (error !== "_errors") {
              showToast(`Error: [${error}] ${message["_errors"]}`, "warning");
            }
          });

          return;
        }

        if (download) {
          downloadFile(data, filename, output);
        }

        if (simulate && output === "json") {
          await teste(hostname, data);
        }

        const code = document.getElementById("code");
        code.textContent = data;
      } catch (error) {
        showToast(error, "error");
      }
    }

    async function teste(hostname, body) {
      const protocol = window.location.protocol;
      const url = `${protocol}//${hostname}/json/state`;

      try {
        const response = await fetch(url, {
          method: "POST",
          body,
        });

        const { ok, status, statusText } = response;

        if (!ok) {
          showToast(`Error: [${status}] ${statusText}`, "error");
          return;
        }

        const { success } = await response.json();

        if (success) {
          showToast("Preset sent successfully!");
        }
      } catch (error) {
        showToast(error, "error");
      }
    }

    function downloadFile(text, filename, output) {
      let mimeType;
      let fileExtension;
      let response;

      switch (output) {
        case "json":
          mimeType = "application/json";
          fileExtension = "json";
          break;
        case "ha":
          mimeType = "application/x-yaml";
          fileExtension = "yaml";
          break;
        case "curl":
          mimeType = "text/plain";
          fileExtension = "txt";
          break;
      }

      const blob = new Blob([text], { type: mimeType });
      const url = URL.createObjectURL(blob);

      const anchorElement = document.createElement("a");
      anchorElement.href = url;
      anchorElement.download = `${filename}.${fileExtension}`;

      anchorElement.click();

      URL.revokeObjectURL(url);
    }

    function showToast(message, type = "success", duration = 3000) {
      const toast = document.createElement("div");
      toast.classList.add("toast", type);

      const body = document.createElement("span");
      body.classList.add("body");
      body.textContent = message;
      toast.appendChild(body);

      const close = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "svg"
      );

      close.setAttribute("class", "close");
      close.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      close.setAttribute("viewBox", "0 0 24 24");
      close.innerHTML =
        '<path fill="#FFFFFF" d="M18.3 6.3c-.4-.4-1-.4-1.4 0L12 10.6 7.7 6.3c-.4-.4-1-.4-1.4 0-.4.4-.4 1 0 1.4L10.6 12l-4.3 4.3c-.4.4-.4 1 0 1.4.2.2.5.3.7.3s.5-.1.7-.3L12 13.4l4.3 4.3c.2.2.5.3.7.3s.5-.1.7-.3c.4-.4.4-1 0-1.4L13.4 12l4.3-4.3c.4-.4.4-1 0-1.4z"/>';
      toast.appendChild(close);

      close.addEventListener("click", () => {
        toast.remove();
      });

      document.getElementById("toast-container").appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = 0;
        setTimeout(() => {
          toast.remove();
        }, 500);
      }, duration);
    }

    window.addEventListener("load", async () => {
      await extractUrlParameters();
    });
  </script>
</html>
